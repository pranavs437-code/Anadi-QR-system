<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anadi Billing System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a1b9a;
            --secondary-color: #e0f2f1;
            --text-color: #333;
            --light-bg-color: #f5f7fa;
            --card-bg-color: #fff;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 6px 10px rgba(0, 0, 0, 0.15);
            --font-family: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--light-bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 0;
        }

        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1f1c2c, #928d8d);
            position: relative;
            overflow: hidden;
        }

        .background-shapes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            list-style: none;
            z-index: 1;
        }

        .background-shapes li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            animation: animate 25s linear infinite;
            bottom: -150px;
        }

        .background-shapes li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .background-shapes li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .background-shapes li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .background-shapes li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .background-shapes li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .background-shapes li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .background-shapes li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .background-shapes li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .background-shapes li:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .background-shapes li:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

        @keyframes animate {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
        }

        #login-box {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            text-align: center;
            width: 100%;
            max-width: 400px;
            z-index: 2;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #login-logo {
            width: 150px;
            margin-bottom: 1.5rem;
        }

        #login-box h1 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .input-field {
            position: relative;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .input-field input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--light-bg-color);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
            outline: none;
        }

        .input-field label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
            transition: 0.3s ease-in-out;
            font-size: 1rem;
        }

        .input-field input:focus,
        .input-field input:not(:placeholder-shown) {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(106, 27, 154, 0.5);
        }

        .input-field input:focus + label,
        .input-field input:not(:placeholder-shown) + label {
            top: 0;
            left: 10px;
            font-size: 0.75rem;
            color: var(--primary-color);
            background-color: var(--light-bg-color);
            padding: 0 5px;
            transform: translateY(-50%);
        }

        .input-field .icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        /* Main App Styles */
        #main-page {
            display: none;
            min-height: 100vh;
            background-color: var(--light-bg-color);
        }

        header {
            background-color: var(--primary-color);
            color: #fff;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--shadow-light);
            gap: 1rem;
        }

        header h2 {
            margin: 0;
            color: #fff;
            font-weight: 600;
        }

        nav {
            display: flex;
            gap: 0.5rem;
        }

        nav button {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 500;
        }

        nav button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        nav button.active {
            background-color: #fff;
            color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .tab {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .tab.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background-color: var(--card-bg-color);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
        }

        .form-section h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
        }

        .form-grid {
            display: grid;
            gap: 1rem;
        }

        .customer-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        input[type="text"], input[type="tel"], input[type="number"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(106, 27, 154, 0.2);
            outline: none;
        }

        .product-entry-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        #cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        #cart-table th, #cart-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        #cart-table th {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        .action-buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #5a148a;
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-secondary {
            background-color: #607d8b;
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: #4a6572;
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-success {
            background-color: var(--success-color);
            color: #fff;
        }

        .btn-success:hover {
            background-color: #388e3c;
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #fff;
        }

        .btn-warning:hover {
            background-color: #f57c00;
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        /* History Tab Styles */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        #historySearchInput {
            flex-grow: 1;
            max-width: 500px;
        }

        .controls-group {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: #fff;
            transform: scale(1.05);
        }
        
        .action-btn svg {
            width: 20px;
            height: 20px;
        }

        .delete-btn { color: var(--danger-color); border-color: var(--danger-color); }
        .delete-btn:hover { background-color: var(--danger-color); color: #fff; }

        .whatsapp-btn svg { fill: #25D366; }
        .whatsapp-btn:hover svg { fill: #fff; }

        .expand-btn {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
            line-height: 1;
        }
        .expand-btn.expanded { transform: rotate(180deg); }

        #bill-history-container {
            display: grid;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .bill-card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--primary-color);
            overflow: hidden;
            cursor: pointer;
        }

        .bill-card.dispatched { border-left-color: var(--success-color); }
        .bill-card.pending { border-left-color: var(--warning-color); }

        .bill-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .bill-card-main {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
        }
        .bill-card-main:hover {
            background-color: #fafafa;
        }

        .bill-info { flex: 1; min-width: 150px; }

        .bill-info h4 { margin: 0; font-size: 1.2rem; }
        .bill-info p { margin: 0; font-size: 0.9rem; color: #666; }

        .bill-status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-weight: 600;
            color: #fff;
            text-transform: capitalize;
            display: inline-block;
            margin-left: 0.5rem;
        }
        .bill-status-badge.pending { background-color: var(--warning-color); }
        .bill-status-badge.dispatched { background-color: var(--success-color); }

        .payment-status {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.25rem;
            display: block;
        }
        .payment-status.paid { color: var(--success-color); }
        .payment-status.unpaid { color: var(--danger-color); }

        .bill-card-actions {
            display: flex;
            justify-content: flex-end;
            padding: 0.75rem 1.5rem;
            gap: 0.5rem;
            align-items: center;
        }

        .payment-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .payment-toggle-container span {
            font-size: 0.9rem;
            color: #666;
        }

        .payment-toggle { display: none; }
        .payment-toggle-label {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            background-color: var(--danger-color);
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .payment-toggle-label::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #fff;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .payment-toggle:checked + .payment-toggle-label { background-color: var(--success-color); }
        .payment-toggle:checked + .payment-toggle-label::after { transform: translateX(20px); }

        .bill-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }

        .bill-details-content {
            padding: 1.5rem;
            background-color: #fafafa;
            border-top: 1px dashed var(--border-color);
        }

        .bill-details-content ul {
            list-style-type: none;
            padding: 0;
            margin: 0.5rem 0 0;
        }

        .bill-details-content li {
            padding: 0.25rem 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow-hover);
            max-width: 500px;
            width: 100%;
            text-align: center;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }
        .modal-lg { max-width: 800px; }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close-btn:hover { color: #555; }

        .manual-dispatch-box {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            align-items: center;
        }
        .manual-dispatch-box input { flex-grow: 1; }

        #qr-reader {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: #333;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            font-size: 1rem;
            min-width: 250px;
        }

        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.warning { background-color: var(--warning-color); }

        @keyframes line-to-box-in {
            0% { clip-path: inset(50% 100% 50% 0); }
            100% { clip-path: inset(0 0 0 0); }
        }
        @keyframes line-to-box-out {
            0% { clip-path: inset(0 0 0 0); }
            100% { clip-path: inset(50% 100% 50% 0); }
        }

        /* Customer Summary Modal Styles */
        .summary-card {
            background-color: #f9f9f9;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            transition: box-shadow 0.3s;
        }

        .summary-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .summary-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
            background-color: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .summary-user-icon {
            background-color: var(--secondary-color);
            border-radius: 50%;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .summary-info {
            flex-grow: 1;
            margin-left: 1rem;
            text-align: left;
        }
        
        .summary-total-section {
            text-align: right;
            margin-right: 1rem;
        }
        
        .summary-total-section p {
            margin: 0;
            font-size: 0.8rem;
            color: #777;
        }
        
        .total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .summary-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }

        .summary-details-content {
            padding: 1.5rem;
        }

        .summary-bill-list {
            list-style-type: none;
            padding: 0;
            margin: 0.5rem 0 0;
        }

        .summary-bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .summary-bill-item:last-child {
            border-bottom: none;
        }

        .summary-bill-item .date {
            font-size: 0.8rem;
            color: #888;
            margin-left: 1rem;
        }
        
        .summary-bill-item .amount {
            font-weight: 600;
            color: var(--text-color);
        }

        /* Print Styles */
        .print-only { display: none; }
        @media print {
            body > *:not(.print-only) { display: none !important; }
            .print-only {
                display: block;
                width: 100%;
                max-width: 4in;
                margin: 0 auto;
                padding: 0.25in;
                font-family: 'Courier New', monospace;
                font-size: 10pt;
            }
            #print-content {
                border: 1px solid #000;
                padding: 0.1in;
            }
            #print-content h2, #print-content p, #print-content hr, #print-content table, #print-content h3 {
                color: #000 !important;
                margin: 0.1in 0;
            }
            #print-content h2 {
                text-align: center;
                font-size: 14pt;
                font-weight: bold;
            }
            #print-content p.center { text-align: center; margin: 0; }
            #print-content hr { border-top: 1px dashed #888; }
            #print-cust-details { font-size: 9pt; }
            #print-items-table { width: 100%; border-collapse: collapse; margin-top: 0.1in; }
            #print-items-table th, #print-items-table td { border-bottom: 1px solid #ccc; padding: 0.05in; text-align: left; font-size: 9pt; }
            #print-items-table th:last-child, #print-items-table td:last-child { text-align: right; }
            #print-total { font-weight: bold; font-size: 12pt; text-align: right; }
            #print-qr-img { display: block; margin: 0.2in auto; max-width: 100%; height: auto; }
            @page {
                size: 4in 6in;
                margin: 0.25in;
            }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div id="login-page" class="no-print">
        <ul class="background-shapes">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div id="login-box">
            <img src="https://anadisevaprakalp.org/wp-content/uploads/elementor/thumbs/anadi-farm-logo-2nd-copy-png-f-pf3gkbrok4it2hn25dsym3ek5sdjquv18uov85lvww.png" alt="Anadi Farms Logo" id="login-logo">
            <h1>Billing System Login</h1>
            <div class="input-field">
                <input type="text" id="username" required placeholder=" ">
                <label for="username">Enter Your Name</label>
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg></span>
            </div>
            <div class="input-field">
                <input type="password" id="password" required placeholder=" ">
                <label for="password">Enter Password</label>
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 9a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1z"/></svg></span>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        </div>
    </div>
    
    <div id="main-page" class="no-print">
        <header>
            <h2>Anadi Billing System</h2>
            <nav>
                <button id="nav-billing" class="active" onclick="showTab('billing')">Billing</button>
                <button id="nav-history" onclick="showTab('history')">History</button>
            </nav>
        </header>
        <div class="container">
            <div id="billing-tab" class="tab active">
                <div class="form-section">
                    <h3>Customer Details</h3>
                    <div class="form-grid customer-grid">
                        <input type="text" id="cust-name" placeholder="Name">
                        <input type="tel" id="cust-phone" placeholder="Phone Number">
                        <input type="text" id="cust-house" placeholder="House No / Address">
                    </div>
                </div>
                <div class="form-section">
                    <h3>Product Details</h3>
                    <div class="product-entry-grid">
                        <input type="text" id="product-name" placeholder="Product Name">
                        <input type="number" id="product-qty" placeholder="Qty" min="0.001" step="0.001">
                        <input type="number" id="product-price" placeholder="Price" min="0">
                        <button class="btn btn-secondary" onclick="addItemToCart()">Add Item</button>
                    </div>
                    <table id="cart-table">
                        <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="action-buttons-container">
                    <button class="btn btn-warning" onclick="clearCart()">Clear Cart</button>
                    <button class="btn btn-success" onclick="generateBill()">Generate Bill</button>
                </div>
            </div>

            <div id="history-tab" class="tab">
                <div class="history-controls form-section">
                    <input type="text" id="historySearchInput" placeholder="Search by Name, Phone, or Bill ID..." oninput="renderHistory()">
                    <div class="controls-group">
                        <button class="action-btn" title="Update Status by QR/Manual" onclick="openDispatchModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41M12 1a2 2 0 0 0-2 2v2H1a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h11.5a.5.5 0 0 0 0-1H1.5a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5H10V3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-1a.5.5 0 0 0 0 1h1a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM0 11.5a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4.5a.5.5 0 0 0 0-1z"/></svg>
                        </button>
                        <button class="action-btn" title="Customer Summary" onclick="openSummaryModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 2.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1zM1 4.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5m1.5 2.5a.5.5 0 0 0 0 1h10a.5.5 0 0 0 0-1zm-1.5 3a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zM11 9.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-1.5 3a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/></svg>
                        </button>
                        <button class="action-btn" title="Export History to PDF" onclick="exportPdfReport()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>
                        </button>
                    </div>
                </div>
                <div id="bill-history-container"></div>
            </div>
        </div>
    </div>

    <div id="billModal" class="modal no-print"><div class="modal-content"><span class="close-btn" onclick="closeBillModal()">&times;</span><h2 id="bill-id-display-modal"></h2><div id="qrcode-modal" style="margin: 20px 0;"></div><div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;"><button class="btn btn-primary" onclick="window.print()">Print Bill</button><button class="btn btn-secondary" onclick="saveAsPdf()">Export to PDF</button></div></div></div>
    <div id="dispatchModal" class="modal no-print"><div class="modal-content"><span class="close-btn" onclick="closeDispatchModal()">&times;</span><h2>Update Bill Status</h2><div id="qr-reader" style="width:100%;"></div><div class="manual-dispatch-box"><input type="number" class="btn" style="background:white; color:rgb(0, 0, 0); border:1px solid #ccc" id="billIdInput" placeholder="Or Enter Code Manually"><button class="btn btn-success" onclick="handleManualDispatch()">Dispatch</button></div><br></div></div>
    <div id="summaryModal" class="modal no-print"><div class="modal-content modal-lg"><span class="close-btn" onclick="closeSummaryModal()">&times;</span><h2>Bill Summary</h2><div id="summary-list-container"></div></div></div>
    <div id="printable-area" class="print-only"><div id="print-content"><h2>Anadi Industries LLP</h2><p class="center"> Ballabhgarh Sohna Road, Pali Village, Faridabad Haryana 121004</p><hr><div id="print-cust-details"></div><hr><table id="print-items-table"></table><hr><h3 id="print-total"></h3><img id="print-qr-img" alt="QR Code"><p class="center">Thank you for your visit!</p></div></div>
    <div id="toastContainer" class="no-print"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbRD_v-hkdNymZ-yH3wZ7DOytXerSsP8Vlo7rH0yRyFFtFtAJK0qsbcX28_Nq874WaXA/exec';
        let cart = [], bills = [], html5QrCode, currentBill = null;
        let customerSummaryData = {};
        const whatsappIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.75,13.96C17.08,14.39 17.21,15.04 17.04,15.54C16.87,16.03 16.46,16.35 15.98,16.5C15.5,16.65 14.88,16.63 14.24,16.39C13.6,16.15 12.38,15.61 11.23,14.45C9.88,13.1 9.05,11.56 8.84,10.93C8.64,10.3 8.8,9.7 9.09,9.29C9.33,8.95 9.68,8.76 10,8.76C10.33,8.76 10.5,8.76 10.63,8.76C10.85,8.76 11.03,8.81 11.21,9.23L11.75,10.5C11.9,10.88 11.91,11.21 11.8,11.48C11.68,11.75 11.53,11.9 11.28,12.15C11.04,12.4 10.9,12.54 10.76,12.68C10.63,12.82 10.48,13.01 10.75,13.28C11.02,13.55 11.63,14.15 12.28,14.81C13.11,15.63 13.75,15.94 14.05,16.09C14.35,16.24 14.58,16.21 14.78,16.03L15.3,15.5C15.68,15.13 16.11,15 16.5,15.03C16.88,15.06 17.63,15.33 17.63,15.33L18.03,13.93C17.76,13.81 17.26,13.55 16.75,13.96M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22C13.66,22 15.25,21.54 16.65,20.73L21.35,22.14L20.06,17.5C21.06,16 21.75,14.11 21.94,12.1C22,11.95 22,11.97 22,12A10,10 0 0,0 12,2Z"/></svg>`;

        document.addEventListener('DOMContentLoaded', async () => {
            showToast("Loading history from database...");
            await loadBills();
            renderHistory();
            const productNameInput = document.getElementById('product-name');
            const productQtyInput = document.getElementById('product-qty');
            const productPriceInput = document.getElementById('product-price');
            productNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); productQtyInput.focus(); } });
            productQtyInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); productPriceInput.focus(); } });
            productPriceInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addItemToCart(); productNameInput.focus(); } });
        });

        async function updateBillOnServer(action, payload) {
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, payload }) });
            } catch (error) {
                console.error('Sync Error:', error);
                throw new Error("Failed to sync with the server.");
            }
        }
        
        async function loadBills() {
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                bills = await response.json();
                showToast("History loaded successfully!", "success");
            } catch (error) {
                console.error('Failed to load bills:', error);
                showToast("Could not load history from database.", "error");
                bills = []; 
            }
        }
        
        function generateBill() {
            const custName = document.getElementById('cust-name').value.trim();
            const custPhone = document.getElementById('cust-phone').value.trim();
            const custHouse = document.getElementById('cust-house').value.trim();
            if (!custName || !custPhone || !custHouse) return showToast("Please fill customer details", "error");
            if (cart.length === 0) return showToast("Cart is empty", "error");
            const bill = {
                id: Math.floor(10000 + Math.random() * 90000),
                customer: { name: custName, phone: custPhone, house: custHouse },
                items: [...cart],
                total: cart.reduce((sum, item) => sum + item.total, 0),
                date: new Date().toLocaleString('en-IN', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true}),
                status: 'pending',
                paymentStatus: 'unpaid'
            };
            currentBill = bill;
            bills.unshift(bill);
            showToast(`Bill #${bill.id} Generated! Saving...`);
            openBillModal(bill);
            updateBillOnServer('addBill', bill)
                .catch(error => {
                    showToast(`Failed to save Bill #${bill.id}.`, "error");
                    bills = bills.filter(b => b.id !== bill.id);
                    renderHistory();
                });
            cart = []; 
            updateCartTable();
            ['cust-name', 'cust-phone', 'cust-house'].forEach(id => document.getElementById(id).value = '');
        }
        
        async function openBillModal(bill) {
            document.getElementById('bill-id-display-modal').innerText = `Unique Code: ${bill.id}`;
            try {
                const canvas = await QRCode.toCanvas(document.createElement('canvas'), JSON.stringify({ billId: bill.id }));
                const qrcodeContainer = document.getElementById('qrcode-modal');
                qrcodeContainer.innerHTML = ''; qrcodeContainer.appendChild(canvas);
                preparePrintableArea(bill, canvas.toDataURL());
            } catch (err) { console.error(err); }
            document.getElementById('billModal').style.display = 'flex';
        }

        function closeBillModal() { document.getElementById('billModal').style.display = 'none'; }
        function closeDispatchModal() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch((err) => console.error("Failed to stop scanner.", err));
            }
            document.getElementById('dispatchModal').style.display = 'none';
        }
        function closeSummaryModal() { document.getElementById('summaryModal').style.display = 'none'; }

        function markAsDispatched(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill || bill.status === 'dispatched') return;
            const originalStatus = bill.status;
            bill.status = 'dispatched';
            renderHistory();
            showToast(`Bill #${billId} marked as Dispatched!`, "success");
            setTimeout(() => sendWhatsApp(billId), 500);
            updateBillOnServer('updateStatus', { billId: billId, status: 'dispatched' })
                .catch(error => {
                    showToast(`Sync failed for Bill #${billId}. Reverting.`, "error");
                    bill.status = originalStatus; renderHistory();
                });
        }
        
        function togglePaymentStatus(billId, isChecked) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;
            const originalPaymentStatus = bill.paymentStatus;
            const newPaymentStatus = isChecked ? 'paid' : 'unpaid';
            bill.paymentStatus = newPaymentStatus;
            renderHistory();
            showToast(`Bill #${billId} marked as ${newPaymentStatus}.`, "success");
            updateBillOnServer('updateStatus', { billId: billId, paymentStatus: newPaymentStatus })
                .catch(error => {
                    showToast(`Sync failed for Bill #${billId}. Reverting.`, "error");
                    bill.paymentStatus = originalPaymentStatus; renderHistory();
                });
        }
        
        function deleteBill(billId) {
            if (!confirm(`Are you sure you want to delete bill #${billId}?`)) return;
            const billIndex = bills.findIndex(b => b.id === billId);
            if (billIndex === -1) return;
            const deletedBill = bills[billIndex];
            bills.splice(billIndex, 1);
            renderHistory();
            showToast(`Bill #${billId} deleted.`, 'error');
            updateBillOnServer('deleteBill', { billId: billId })
                .catch(error => {
                    showToast(`Could not delete Bill #${billId} from server.`, "error");
                    bills.splice(billIndex, 0, deletedBill); renderHistory();
                });
        }
        
        function openSummaryModal() {
            generateCustomerSummary();
            const container = document.getElementById('summary-list-container');
            const summaryValues = Object.values(customerSummaryData).sort((a, b) => b.totalAmount - a.totalAmount); // Sort by total amount

            const userIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg>`;
            const expandIcon = `▼`; // Using a simple character for the icon

            if (summaryValues.length === 0) {
                container.innerHTML = `<p style="text-align: center; padding: 2rem 0;">No customer history found.</p>`;
            } else {
                container.innerHTML = summaryValues.map(summary => {
                    const chronologicalBills = [...summary.allBills].reverse();
                    return `
                    <div class="summary-card">
                        <div class="summary-card-header" onclick="toggleSummaryDetails(this)">
                            <div class="summary-user-icon">${userIcon}</div>
                            <div class="summary-info">
                                <p><strong>${summary.customerInfo.name}</strong></p>
                                <p>${summary.customerInfo.phone}</p>
                            </div>
                            <div class="summary-total-section">
                                <p>Total Purchase</p>
                                <span class="total-amount">₹${summary.totalAmount.toFixed(2)}</span>
                            </div>
                            <div class="summary-actions">
                                <button class="action-btn whatsapp-btn" title="Send Summary on WhatsApp" onclick="event.stopPropagation(); sendSummaryWhatsApp('${summary.customerInfo.phone}')">${whatsappIcon}</button>
                                <button class="action-btn expand-btn" title="View Details">${expandIcon}</button>
                            </div>
                        </div>
                        <div class="summary-details">
                            <div class="summary-details-content">
                                <h4>Purchase History (${chronologicalBills.length} Bills)</h4>
                                <ul class="summary-bill-list">
                                    ${chronologicalBills.map(bill => `
                                        <li class="summary-bill-item">
                                            <div>
                                                <strong>Bill #${bill.id}</strong>
                                                <span class="date">${bill.date}</span>
                                            </div>
                                            <span class="amount">₹${bill.total.toFixed(2)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function toggleSummaryDetails(headerElement) {
            const card = headerElement.closest('.summary-card');
            const detailsDiv = card.querySelector('.summary-details');
            const expandBtn = card.querySelector('.expand-btn');
            const isExpanded = detailsDiv.style.maxHeight && detailsDiv.style.maxHeight !== "0px";

            if (isExpanded) {
                detailsDiv.style.maxHeight = "0px";
                expandBtn.style.transform = 'rotate(0deg)';
            } else {
                const content = detailsDiv.querySelector('.summary-details-content');
                detailsDiv.style.maxHeight = content.scrollHeight + 40 + "px"; // 40px for padding
                expandBtn.style.transform = 'rotate(180deg)';
            }
        }

        function generateCustomerSummary() {
            customerSummaryData = {};
            bills.forEach(bill => {
                const phone = bill.customer.phone;
                if (!customerSummaryData[phone]) {
                    customerSummaryData[phone] = { customerInfo: bill.customer, totalAmount: 0, allBills: [] };
                }
                customerSummaryData[phone].allBills.push(bill);
                customerSummaryData[phone].totalAmount += bill.total;
            });
        }

        function sendSummaryWhatsApp(phone) {
            const summary = customerSummaryData[phone];
            if (!summary) return;
            let message = `*Purchase Summary for ${summary.customerInfo.name}*\n\n*Name:* ${summary.customerInfo.name}\n*Phone:* ${summary.customerInfo.phone}\n*Address:* ${summary.customerInfo.house}\n------------------------------------\n\n`;
            const chronologicalBills = [...summary.allBills].reverse();
            chronologicalBills.forEach(bill => {
                message += `*Bill #${bill.id}* (${bill.date})\n`;
                bill.items.forEach(item => { message += `- ${item.name} (Qty: ${item.qty}, Price: ₹${item.price.toFixed(2)})\n`; });
                message += `_Bill Total: ₹${bill.total.toFixed(2)}_\n\n`;
            });
            message += `------------------------------------\n*GRAND TOTAL: ₹${summary.totalAmount.toFixed(2)}*\n\nThank you for shopping with us!`;
            const formattedPhone = formatPhoneNumberForWhatsApp(phone);
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${formattedPhone}?text=${encodedMessage}`, "_blank");
        }

        function handleLogin() {
            const username = document.getElementById('username').value, password = document.getElementById('password').value;
            if (!username.trim()) return showToast("Please enter your name", "error");
            if (password === "anadi") {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-page').style.display = 'block';
                showToast(`Welcome, ${username}!`);
            } else { showToast("Incorrect Password", "error"); }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabId}-tab`).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            if (tabId === 'history') renderHistory();
        }

        function addItemToCart() {
            const name = document.getElementById('product-name').value.trim(),
                qty = parseFloat(document.getElementById('product-qty').value),
                price = parseFloat(document.getElementById('product-price').value);
            if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price < 0) return showToast("Please fill all product fields correctly", "error");
            cart.push({ name, qty, price, total: qty * price });
            updateCartTable();
            ['product-name', 'product-qty', 'product-price'].forEach(id => document.getElementById(id).value = '');
        }

        function updateCartTable() {
            const tbody = document.querySelector('#cart-table tbody');
            tbody.innerHTML = ''; let grandTotal = 0;
            cart.forEach((item) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>₹${item.price.toFixed(2)}</td><td>₹${item.total.toFixed(2)}</td>`;
                tbody.appendChild(row); grandTotal += item.total;
            });
            if (cart.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.style.fontWeight = "bold";
                totalRow.innerHTML = `<td colspan="3">Grand Total</td><td>₹${grandTotal.toFixed(2)}</td>`;
                tbody.appendChild(totalRow);
            }
        }

        function clearCart() {
            if (cart.length > 0 && confirm("Are you sure you want to clear the entire cart?")) {
                cart = []; updateCartTable(); showToast("Cart cleared!", "error");
            }
        }

        function saveAsPdf() {
            if (!currentBill) return showToast("No bill has been generated to save.", "error");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: [4, 6] });
            const margin = 0.25, pageWidth = 4, pageHeight = 6, contentWidth = pageWidth - (margin * 2);
            let y = margin;
            doc.setFontSize(16); doc.setFont('helvetica', 'bold');
            doc.text('Anadi Industries LLP', pageWidth / 2, y, { align: 'center' });
            y += 0.2; doc.setFontSize(8); doc.setFont('helvetica', 'normal');
            doc.text('Ballabhgarh Sohna Road, Pali Village, Faridabad Haryana 121004', pageWidth / 2, y, { align: 'center', maxWidth: contentWidth });
            y += 0.25; doc.setLineWidth(0.01); doc.line(margin, y, pageWidth - margin, y); y += 0.2;
            doc.setFontSize(10); doc.setFont('helvetica', 'bold');
            doc.text('Bill To:', margin, y); doc.setFont('helvetica', 'normal');
            doc.text(currentBill.customer.name, margin + 0.6, y); y += 0.2;
            doc.setFont('helvetica', 'bold');
            doc.text('Phone:', margin, y); doc.setFont('helvetica', 'normal');
            doc.text(currentBill.customer.phone, margin + 0.6, y); y += 0.2;
            doc.setFont('helvetica', 'bold');
            doc.text('Address:', margin, y); doc.setFont('helvetica', 'normal');
            const addressLines = doc.splitTextToSize(currentBill.customer.house, contentWidth - 0.7);
            doc.text(addressLines, margin + 0.6, y); y += (addressLines.length * 0.18) + 0.1;
            doc.setFont('helvetica', 'bold');
            doc.text(`Bill ID: ${currentBill.id}`, margin, y);
            doc.text(`Date: ${currentBill.date}`, pageWidth - margin, y, { align: 'right' });
            y += 0.2; doc.line(margin, y, pageWidth - margin, y);
            const tableHead = [['Item', 'Qty', 'Price (Rs)', 'Amount (Rs)']];
            const tableBody = currentBill.items.map(item => [item.name, item.qty, item.price.toFixed(2), item.total.toFixed(2)]);
            doc.autoTable({ head: tableHead, body: tableBody, startY: y + 0.1, theme: 'striped', headStyles: { fillColor: [240, 240, 240], textColor: 20, fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 0.07 }, columnStyles: { 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' } }, margin: { left: margin, right: margin } });
            y = doc.autoTable.previous.finalY;
            y += 0.3; doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text(`Grand Total: Rs ${currentBill.total.toFixed(2)}`, pageWidth - margin, y, { align: 'right' });
            const qrImgData = document.getElementById('print-qr-img').src;
            const qrSize = 1.2, qrX = (pageWidth - qrSize) / 2, qrY = pageHeight - margin - qrSize - 0.3;
            if (y < qrY) {
                doc.addImage(qrImgData, 'PNG', qrX, qrY, qrSize, qrSize);
                doc.setFontSize(9); doc.setFont('helvetica', 'italic');
                doc.text('Thank you for your visit!', pageWidth / 2, pageHeight - margin - 0.1, { align: 'center' });
            }
            try {
                doc.save(`bill-${currentBill.id}.pdf`);
                showToast("PDF export started!", "success");
            } catch(err) { showToast("Could not export PDF file.", "error"); }
        }

        function preparePrintableArea(bill, qrDataUrl) {
            document.getElementById('print-cust-details').innerHTML = `<p><strong>Bill To:</strong> ${bill.customer.name}</p><p><strong>Phone:</strong> ${bill.customer.phone}</p><p><strong>Address:</strong> ${bill.customer.house}</p><p><strong>Date:</strong> ${bill.date}</p><p><strong>Bill ID:</strong> ${bill.id}</p>`;
            const itemsTbody = bill.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.total.toFixed(2)}</td></tr>`).join('');
            document.getElementById('print-items-table').innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Amt</th></tr></thead><tbody>${itemsTbody}</tbody>`;
            document.getElementById('print-total').innerText = `Total: ₹${bill.total.toFixed(2)}`;
            document.getElementById('print-qr-img').src = qrDataUrl;
        }

        function renderHistory() {
            const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
            
            const filteredBills = bills.filter(bill =>
                bill.customer.name.toLowerCase().includes(searchTerm) ||
                bill.customer.phone.toString().includes(searchTerm) ||
                bill.id.toString().includes(searchTerm)
            );

            filteredBills.sort((a, b) => new Date(b.date) - new Date(a.date));

            const container = document.getElementById('bill-history-container');
            container.innerHTML = filteredBills.length === 0 ? '<p style="text-align:center;">No bills found.</p>' : '';
            
            filteredBills.forEach(bill => {
                const card = document.createElement('div');
                card.className = `bill-card ${bill.status}`;
                card.innerHTML = `<div class="bill-card-main" onclick="toggleDetails(this, ${bill.id})"><div class="bill-info bill-id"><h4>#${bill.id}</h4><span class="bill-status-badge ${bill.status}">${bill.status}</span></div><div class="bill-info bill-customer"><p><strong>${bill.customer.name}</strong></p><p>${bill.customer.phone}</p></div><div class="bill-info bill-total"><h4>₹${bill.total.toFixed(2)}</h4><span class="payment-status ${bill.paymentStatus}">${bill.paymentStatus.toUpperCase()}</span></div></div><div class="bill-card-actions"><div class="payment-toggle-container" title="Toggle Payment Status" onclick="event.stopPropagation()"><span>Payment:</span><input type="checkbox" id="pay-toggle-${bill.id}" class="payment-toggle" onchange="togglePaymentStatus(${bill.id}, this.checked)" ${bill.paymentStatus === 'paid' ? 'checked' : ''}><label for="pay-toggle-${bill.id}" class="payment-toggle-label"></label></div><button class="action-btn whatsapp-btn" title="Send on WhatsApp" onclick="sendWhatsApp(${bill.id})">${whatsappIcon}</button><button class="action-btn delete-btn" title="Delete Bill" onclick="deleteBill(${bill.id})">🗑️</button><button class="action-btn expand-btn" title="View Details" onclick="toggleDetails(this.parentElement.previousElementSibling, ${bill.id})">▼</button></div><div class="bill-details"><div class="bill-details-content"></div></div>`;
                container.appendChild(card);
            });
        }
        
        function toggleDetails(headerElement, billId) {
            const card = headerElement.closest('.bill-card');
            const expandBtn = card.querySelector('.expand-btn');
            const detailsDiv = card.querySelector('.bill-details');
            const isExpanded = detailsDiv.style.maxHeight && detailsDiv.style.maxHeight !== "0px";
            if (isExpanded) {
                detailsDiv.style.maxHeight = "0px";
                expandBtn.classList.remove('expanded');
            } else {
                const bill = bills.find(b => b.id === billId);
                const content = detailsDiv.querySelector('.bill-details-content');
                content.innerHTML = `<p><strong>Address:</strong> ${bill.customer.house}</p><strong>Items:</strong><ul>${bill.items.map(i => `<li>${i.name} (Qty: ${i.qty}) - ₹${i.total.toFixed(2)}</li>`).join('')}</ul>`;
                detailsDiv.style.maxHeight = content.scrollHeight + 40 + "px";
                expandBtn.classList.add('expanded');
            }
        }
        
        function handleManualDispatch() {
            const id = parseInt(document.getElementById('billIdInput').value);
            if(!isNaN(id)) markAsDispatched(id);
            document.getElementById('billIdInput').value = '';
        }

        function formatPhoneNumberForWhatsApp(phone) {
            let cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.startsWith('0')) cleaned = cleaned.substring(1);
            if (cleaned.length === 10) return '91' + cleaned;
            return cleaned;
        }

        function sendWhatsApp(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;
            const formattedPhone = formatPhoneNumberForWhatsApp(bill.customer.phone);
            const itemsText = bill.items.map(i => `${i.name} (Qty: ${i.qty}) - ₹${i.total.toFixed(2)}`).join('%0A');
            const message = `*Bill Details*%0A%0ABill ID: *${bill.id}*%0ACustomer: *${bill.customer.name}*%0ADispatch Status: *${bill.status.toUpperCase()}*%0APayment Status: *${bill.paymentStatus.toUpperCase()}*%0A%0A--- Items ---%0A${itemsText}%0A%0ATotal Amount: *₹${bill.total.toFixed(2)}*`;
            window.open(`https://wa.me/${formattedPhone}?text=${message}`, "_blank");
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.textContent = message;
            toast.style.animation = 'line-to-box-in 0.6s ease-out forwards';
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'line-to-box-out 0.6s ease-in forwards';
                setTimeout(() => { toast.remove(); }, 600);
            }, 4400);
        }

        function openDispatchModal() {
            if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => console.error(err)); }
            document.getElementById('dispatchModal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("qr-reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                try {
                    const data = JSON.parse(decodedText);
                    if (data.billId) { markAsDispatched(data.billId); closeDispatchModal(); }
                } catch (e) { showToast("Invalid QR Code.", "error"); }
            };
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrCodeSuccessCallback)
                .catch((err) => { document.getElementById('qr-reader').innerHTML = '<p style="color: red; font-weight: bold;">Could not start camera.</p>'; });
        }

        function exportPdfReport() {
            if (bills.length === 0) return showToast("No bills to export to PDF.", "error");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            
            const headers = [["Sr.", "Customer Name", "Phone", "Address", "Product", "Qty", "Price", "Total", "Date", "Dispatch Status", "Payment Status"]];
            
            const reportData = []; 
            let serialNumber = 1, grandTotal = 0;

            bills.forEach(bill => {
                const formattedDate = new Date(bill.date).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                bill.items.forEach(item => {
                    reportData.push([
                        serialNumber++,
                        bill.customer.name,
                        bill.customer.phone,
                        bill.customer.house,
                        item.name,
                        item.qty,
                        `Rs ${item.price.toFixed(2)}`,
                        `Rs ${item.total.toFixed(2)}`,
                        formattedDate,
                        bill.status,
                        bill.paymentStatus
                    ]);
                    grandTotal += item.total;
                });
            });

            doc.setFontSize(18); 
            doc.setFont('helvetica', 'bold');
            doc.text("Anadi Industries - Bill Report", 40, 40);

            doc.autoTable({
                head: headers,
                body: reportData,
                startY: 60,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 4 },
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 30 },
                    3: { cellWidth: 120 },
                    4: { cellWidth: 90 },
                    8: { cellWidth: 90 },
                    9: { cellWidth: 60 },
                    10: { cellWidth: 60 },
                    5: { halign: 'right' },
                    6: { halign: 'right' },
                    7: { halign: 'right' }
                }
            });

            let finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Grand Total: Rs ${grandTotal.toFixed(2)}`, 40, finalY + 30);

            try {
                doc.save(`Bill_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast("PDF export started!", "success");
            } catch(err) {
                showToast("Could not export PDF file.", "error");
            }
        }
    </script>
</body>
</html>